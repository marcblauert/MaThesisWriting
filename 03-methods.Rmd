<!--
Chapter 3 - Methods
-->

```{r setup3, echo=FALSE}
pacman::p_load(tidyverse, thesisdown, knitr, kableExtra)

# Set how wide the R output will go
options(width = 70)
```

# Methods {#methods}

## Data description and pre-processing {#data}

To translate the conceptual model set up in Chapter \@ref(conceptual-model) into a statistical model that can be used to empirically investigate the price elasticity of space heating demand, data from multiple sources were combined.

**Energy billing dataset**

The key dataset is a large-scale building-level panel of energy bills made available though the Climate Policy Department at DIW Berlin. The data originates from the energy- and billing service provider ista Deutschland GmbH and was provided for scientific use.[^31] The sample contains information on an average of multi-unit residential buildings in Germany and ranges from 2007 to 2019.[^32] The smallest buildings observed have two living units; single-family houses with just one unit are not observed. The observations in the dataset represent annual heating bills at the building-level. The dataset contains the two main variables for the analysis: space heating demand and energy price. It also contains additional building-level information including the heating surface, the number of housing units, the type of energy carrier used for heating. The dataset also provides a building-level ID and the billing dates suitable to create a panel structure.

[^31]: Due to the sensitivity of the data, it is to be classified as confidential. Access was exclusively via DIW Berlin's internal servers. Due to data protection regulations, it is not possible to make the data available to external parties for the purpose of reproducing the results.

[^32]: The While the demand data is available from the start, energy prices are first observed in 2007. Thus, the time period analysed ranges from 2007 to 2019.

**Space heat demand (kWh/sqm/a):** The demand data in the billing dataset is provided as total energy consumed per building and per annual billing period in kilowatt hours (kWh). To isolate the share of energy consumed for the purpose of space heating, the share of energy used for hot water production is deduced for those buildings where hot water production is also done via the central heating system. In a second step, in order to obtain a comparable metric for the differently sized buildings in the sample, the total space heating demand at building level is divided by the building heating surface in square meters (sqm). This results in the annual space heat demand per square meter as the demand variable. For a summary of the variables and their data sources see Table \@ref(tab:variables).

**Energy prices (Cents/kWh):** The structure of the price data in the dataset is similar to that of the demand data. The energy price data is provided as total annual costs at the building-level in Euros. Again, relying on the supplementary information on the relative shares of energy use for space heating and hot water generation in buildings where hot water is provided via the central heating system, the cost share for space heating alone is identified. In a second step, the cost share for space heating is then translated into average per-unit costs by dividing total costs for space heating by the respective demand for space heating in kWh. To make the cost scale more intuitive, prices are furthermore converted from Euros to Cents. This yields a per-unit energy price variable (Cents/kWh). Additionally, since energy prices are provided as nominal prices, they are deflated using the German annual consumer price index (CPI) with 2015 as the index year [@destatis21]. The use of the CPI to deflate energy prices represents the standard procedure in the literature, which is also used by @schmitz_madlener20, for example.

Energy contracts for private households in Germany usually consist of a fixed cost component (flat-rate basic charge) and a variable cost component (consumption-based price per kWh).[^33] The data does not contain a breakdown of fixed and variable costs, but only the total costs, which are then converted into average costs per-unit (the sum of fixed and variable costs divided by the quantity demanded) as described in the previous paragraph. There is much debate in the literature about whether the household demand response to changes in energy prices depends on the average price or instead on the marginal price. The use of marginal prices would be necessary if the variable price component were to change based on the quantity consumed ("block pricing") and could also be dynamically adjusted by the utility, as is the case for many private household contracts in the USA, for example [see @auffhammer_rubin18]. Since those factors do not apply for the energy contracts underlying the billing data used in this thesis, I assume the use of the average per-unit energy price to be suitable, as it was also done in other studies [e.g., @metcalf_hassett99; @rehdanz07; @schmitz_madlener20]

[^33]: On the basis of exemplary heating bills provided by ista, it was possible to determine that this was also the case for the data in the billing sample.

Another problem is whether the demand decisions depend on the price in the same period or on the price of the previous period, so that the calculation of the previous period influences the current demand decisions. Following the approach of @schmitz_madlener20, I generally construct the model with the price in the same period. However, to check the robustness of the results, I also run models with the price of the previous period.

**(Billing) Year:** The billing data contains the exact dates of the billing period of an individual building. While most billing periods mirror the calendar year, some buildings have billing periods occurring during the year. Therefore, the start and end dates of the billing periods are used to make an allocation to billing years. For billing periods during the year, the allocation is based on which of the two calendar years contains the majority of days in the billing period.

**Energy carrier group:** There are three main types of energy carriers included in the dataset: Gas, oil, and district heating. To obtain these three categories, energy carrier descriptions from the dataset are grouped under these categories (e.g, *Gas low* and *Gas high* are grouped under *Gas*). In addition, all other heating carriers which have only limited occurrence in the sample (e.g. electricity for heat pumps, coal combustion) are grouped under the category *Others* and later excluded from the analysis due to the relatively small number of observations and heterogeneity of carrier types within the group (see Chapter \@ref(workflow)).

**Heating surface (sqm):** Information on the heating surface of a building is given in square meters at building-level. The heating surface does not correspond to the total floor area of a building, as it excludes the unheated surfaces within a buildings (e.g., building corridors or basements). Heating area was chosen over the number of housing units as an alternative approximation for the size of a building. The reasons for this are that it was assumed that the heating surface better reflects the ratio between the interior and exterior area of a building since it does not suffer from varying sizes of housing units.[^7773] 

[^7773]: While this paper uses building heating surface as a continuous variable, other studies with a less detailed database often use building size categories, which can be seen as a similar approach.

\begin{table}[]
\centering
\caption{Variables and data sources}
\label{tab:variables}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}lllll@{}}
\toprule
\textbf{Variable} & \textbf{} & \textbf{Type} & \textbf{Unit} & \textbf{Data source} \\ \midrule
 &  &  &  &  \\
\textit{\begin{tabular}[c]{@{}l@{}}Demand\\ \end{tabular}} & Space heat demand & Continuous & ln(kWh/sqm/a) & Ista (billing data) \\
\textit{} &  &  &  &  \\
\textit{\begin{tabular}[c]{@{}l@{}}Price\\ \end{tabular}} & Energy price & Continuous & ln(Cents/kWh) & Ista (billing data)\\
\textit{} &  &  &  &  \\
\multirow{4}{*}{\textit{\begin{tabular}[c]{@{}l@{}}Additional billing \\information\\ \end{tabular}}} & Heating surface & Continuous & ln(sqm) & Ista (billing data)\\
 & Energy carrier group & Categorical & Gas / Oil / District heating & Ista (billing data)\\
 & Building ID & Categorical & - & Ista (billing data)\\
 & Year & Categorical & - & Ista (billing data)\\
\textit{} &  &  &  &  \\
\textit{\begin{tabular}[c]{@{}l@{}}Climatic conditions\\ \end{tabular}} & Degree days & Continuous & ln(degree days) & IWU (2021) \\
\textit{} &  &  &  &  \\
\multirow{3}{*}{\textit{\begin{tabular}[c]{@{}l@{}}Socio-economic factors\\ \end{tabular}}} &  District per capita household income & Continuous & ln(Euros/a) & Statistische Ämter (2021) \\
 & District retirement share & Continuous & \% & DESTATIS (2021a) \\
 & Postal code population density & Continuous & ln(inhabitants/sq. km) & OSM (2021), OSM (2021a) \\ \bottomrule
\end{tabular}%
}
\end{table}

\newline

**Supplementary data sources**

**Degree days:** Degree days were retrieved from an Excel tool compiled by the *Institut für Wohnen und Umwelt (IWU)* at the postal code level [@iwu21]. The degree days data from the IWU-tool builds on daily temperature data from the 800 weather stations of the German Meteorological Service (DWD) that are aggregated on a monthly basis. In the tool, the settings of a mean room temperature of 20°C and a heating limit of 15°C are chosen to reflect the VDI based definition of degree days [@vdi13]. Furthermore, the option to assign the postal code area to the three nearest DWD weather stations with weighting according to geographical distance is chosen. This is because relying on  reduce the risk of possible distortions due to differences in altitude between a single weather station and the centroid of a postal code area. The extracted monthly degree day figures per postal code area are then aggregated to annual periods on a rolling basis and matched with the annual building-level energy billing observations. The postal code level was chosen because it corresponds to the spatial information on the location of the buildings contained in the billing data and therefore represents the most accurate allocation possible.

**District per capita household income (Euros/a):** As a district-level income variable to approximate for varying incomes, the per capita disposable income of private households provided by the joint statistical portal of the federal and state governments is used [@statistischeamter21]. The figure includes the primary income of private households, minus transfers paid and plus transfers received. Disposable income is chosen because it can be considered the most suitable indicator for funds available for households. The district-level is chosen as it is the most granular household income statistics available.

**District retirement share (%):** To construct the district retirement share variable, population data at the district-level with a segmentation by age groups is used [@destatis21c]. As an approximation for the actual proportion of retirees, the percentage of persons within a district and year who are 65 years of age and older is calculated. This approach was chosen because no detailed statistics are available on the number of people in retirement at the district-level. The boundary value of 65 was chosen as the age group closest to the current retirement age in Germany and since the same threshold was also chosen in the literature (e.g., @alberini_etal11) 

**(Postal code) Population density (inh./sq. km):** To generate the population density variable, data from Open Street Maps with pre-assigned population figures to postal code areas based on the 2011 Census were used [@osm21; @osm21a]. The postal code level and not the district level was chosen because, firstly, a higher granularity of data was available and, secondly, the use of districts as the level of analysis may obscure heterogeneity within districts. Especially when they are rural districts with a city. To determine the population density variable, the number of inhabitants per postal code was divided by the base area in square kilometers (sq. km), giving the population density as the average number of inhabitants per sq. km.

## Empirical approach {#empirical-model}

**Causality with observational data**

The conceptual DAG presented in Chapter \@ref(conceptual-model) and the derived rationales for the cause-and-effect relationships between space heat demand and energy price in an environment where the other explanatory variables also exert an effect on energy demand are all based on the assumption of causal inference. Causal inference can be described as indicating that an observed relationship between two variables is reflected by a causal link and not just mere correlation [@holland86]. The analysis in this thesis is build on externally provided observational data. Using observational data to draw causal inference about a treatment effect -- in the given case, inference about the price sensitivity of private households for space heating demand in multi-family buildings in Germany -- is inherently difficult since the treatment is not controllable and therefore cannot be randomly assigned [@nichols07]. Since an experimental research design, which would arguably provide the most unbiased source of evidence, is not feasible for this research, it is all the more important to point out potential sources of bias in the estimation process relying on observational data and address those biases where possible.

**Potential sources of bias**

Reducing potential sources of bias was approached in several steps. First, the set of explanatory variables already described was used to reduce potential bias from omitted variables. This means that by taking into account, for example, degree days or the heating surface of a building, additional relevant effects on the level of heating demand are captured that might otherwise be wrongly attributed to the role of energy price alone.

On the other hand, there is also an additional gap in the data in relation to the omitted variables that cannot be fully remedied. Due to the aggregated nature of the data at the building-level, it is not possible to integrate detailed household-level socio-economic variables (e.g., household income, number of inhabitants, age, education level, or employment status) into the analysis. In other studies which build on household-level social surveys socio-economic variables have been found to be a relevant determinant of energy demand -- especially household income is a variable that has been found to exert a relevant effect [e.g., @meier_rehdanz10; @rehdanz07; @schmitz_madlener20]. To at least partially address the fact that socio-economic variables are not available at the household level, socio-economic controls at the district or postcode level are used to try to capture the underlying socio-economic effects at a higher level.

Another source of potential bias can result from data errors. In general, the use of observational data should not be considered a mechanistic process, but should be based on the application of domain-specific knowledge to critically evaluate and challenge the available data. In view of the potentially distorting effects of data errors, the use of domain-specific knowledge and expert judgement was important in cleaning and processing the energy billing dataset. The process is described in detail later in this Chapter (see Chapter \@ref(Workflow)). When evaluating the energy price variable, outliers are found that can be traced back to be placeholders that do not reflect the actual energy demand. If these observations had not been removed from the analysis, they would have distorted the result of the analysis.

In addition, it was checked if the measurement of the variables incorporated any systematic measurement error and concluded that a systematic error was not present. Generally, several variables used in the analysis might be subject to measurement error. For example, the degree days data are based on a spatial interpolation of the values from the three nearest DWD weather stations to the centroid of a postal code, which introduces a first layer of measurement error. It is then assumed that the degree days assigned to a postal code apply to every building within that postal code, even though there may be greater distances and differences in elevation between the centroid and the building's location representing a second layer . However, errors such as those described exemplarily for the degree days variable do not necessarily represent a problem, since a systematic deviation is required for the existence of a systematic error (bias). Rather, the described exemplary derivations from a true value for outdoor temperature indicate a random inaccuracy in the measurement of the variable, which is less serious in general and especially given the very large number of observations in the sample. The same logic applies, for example, to the construction of the energy demand variable. While aggregation at the building level introduces some inaccuracy compared to a hypothetical measurements at the household-level, it does not lead to a systematic error.

**Simultaneity problem**

Furthermore, when estimating price elasticities of demand, one additional relevant challenge for the identification of a causal effect is the potential simultaneous determination of price and demand leading to a market equilibrium 

- Use of multiple estimation techniques (panel regression, Bayesian mutilevel models)

- Issue of Simultaneity (See Aufhammer)

- If demand is assumed to depend on the marginal block price, then price and consumption are simultaneously determined, and instrumental variable estimation techniques must be used (Burtless and Hausman, 1978; McFadden et al., 1978; Wilder and Willenborg, 1975; Hewitt and Hanemann, 1995; Reiss and White, 2005). For lack of exact information about the block rates faced by the consumers, however, we are forced to use average price.

- Perhaps most importantly, research on the elasticity of demand for natural gas must also consider multiple potential sources of endogeneity. The first source of endogeneity is the classic simultaneity that stems from the fact that quantity and price result from the equilibrium in a system of equations. Unlike the electricity sector, for natural-gas customers’ rates change on a monthly basis—updating as a function of gas wholesale prices paid by the retail utilities.

- From Aufhammer wegen IV approach: We instrument the utilities’ consumer-facing prices with the weekly average spot price of natural gas at a major natural gas distribution hub in Louisiana (the Henry Hub). This instrument is valid, as we know the formula of how utilities pass-through the price (providing a strong first stage), and the price is determined prior to within-bill consumption (strengthening the exclusion restriction).

**Frequentist estimation approach**

For the analysis, I use several statistical methods. For the full sample analysis, I rely on Frequentist estimation approaches given the large number of data points in the billing dataset. For the subsequent analysis of a stratified random subsample I rely on Bayesian methods. Generally, I follow a logic where I begin with constructing a simple model specification and then extend it to a more elaborate statistical model. The goal partly being to be able to compare model estimates by varying methods and predictors included.

To start with, I formulate the statistical model for the full sample analysis as a simple cross-sectional multiple linear regression (MLR) model based on ordinary least squares (OLS) [@bailey17; @wooldridge13]:

```{=tex}
\begin{align*}
ln(Demand) & = \alpha + \beta_1 \cdot ln(Price) + \beta_2 \cdot ln(Degree.days) + \\
 & \quad \beta_3 \cdot ln(Heating.surface) + \beta_{4} \cdot Carrier.group.oil + \\
 & \quad \beta_{5} \cdot Carrier.group.district.heating + \beta_{6} \cdot ln(District.income) + \\
 & \quad \beta_{7} \cdot District.retire + \beta_{8} \cdot ln(Pop.density) + \varepsilon 
\end{align*}
```

where the response variable $ln(Demand)$ denotes the natural logarithm of the annual space heating demand per square meter, the main explanatory variable $ln(Price)$ denotes the natural logarithm of the average energy price (Cents/kWh) in the same period. The other terms of the linear equation denote the additional explanatory variables (degree days, building characteristics, and district/postal code socio-economic variables) and $\varepsilon$ denotes the error term of the model. Referring back to equation \@ref(eq:demand2) from the theory Chapter, the ln-form of both sides of the equation transforms the model into the elasticity case. Therefore, the coefficient $\beta_1$ of $ln(Price)$ represents the price elasticity of space heating demand. For the cross-sectional OLS regression, I first run the model with $ln(Price)$ as a sole predictor and then with the additional explanatory variables included.

In the billing dataset, there is both a building ID, which allows observations from several periods to be assigned to the same building, and information on the billing period. Thus, the data allows to go beyond cross-sectional OLS and apply panel data estimation techniques. In the OLS estimation shown above, observations from various buildings and years are treated to be systematically no different from each other. Panel data methods, on the contrary, are rooted in the assumption that there may be systematic and unobserved differences between units that may be correlated with observed predictors whose effects on the response are to be measured [@wooldridge13]. Thus, panel data methods are considered a powerful tool for observational data where controlling for all relevant factors is inherently difficult [@bailey17]. By acknowledging and addressing that there may be unobserved inter-individual differences between the units (buildings) and also an intra-individual dynamic over time (years), use of panel data methods can provide a more accurate picture for the predictors observed in the model.

For the subject at hand, it is likely that the demand for space heating observed is impacted by various unobserved building-specific constant or semi-constant factors, such as a building's energetic condition or its usage properties. Thus, inferences drawn from cross-sectional data are likely to be invalid since building-specific fixed-effects are falsely attributed the observed model predictors -- including energy price. The same applies for temporal trends. For example, new buildings with higher energetic standards could be added to the sample over the course of the observation period and old buildings might drop out of the sample due to demolition. Such factors, which affect the structural composition of the sample over time, may result in space heating demand in the later periods being systematically lower than that in the earlier periods. In the empirical literature, switching from a cross-sectional model to the use of unit-level fixed effects with panel data resulted in a more inelastic estimates for the price elasticity of space heating demand [@miller_alberini16].

In addition, the choice of panel estimation method should provide more reliable results even when strict exogeneity fails to hold. Therefore, I adopt a two-way fixed effects (FE) model, which is considered one of the more robust estimation methods and is also a commonly used approach in the prior literature on the price elasticity of heating demand [e.g., @meier_rehdanz10; @lange_etal14; @schmitz_madlener20]. The FE model takes the following form:

```{=tex}
\begin{align*}
ln(Demand_{i,t}) & = \alpha + \beta_1 \cdot ln(Price_{i,t}) + \beta_2 \cdot ln(Degree.days_{i,t}) + \\
 & \quad \beta_3 \cdot ln(Heating.surface_{i,t}) + \beta_{4} \cdot Carrier.group.oil_{i,t} + \\
 & \quad \beta_{5} \cdot Carrier.group.district.heating_{i,t} + \beta_{6} \cdot ln(District.income_{i,t}) + \\
 & \quad \beta_{7} \cdot District.retire_{i,t} + \beta_{8} \cdot ln(Pop.density_{i,t}) + \\
 & \quad \gamma_{building[i]} + \delta_{year[t]} + \varepsilon_{i,t}
\end{align*}
```

The FE model structure extends the cross-sectional OLS model. The response variable $ln(Demand_{i,t})$ again denotes the natural logarithm of the annual space heating demand per square meter but extended by the indices on building $i$ and the annual time period $t$. The same applies to $ln(Price_{i,t})$ as the average energy price (Cents/kWh) and the set of additional explanatory variables. The newly added term $\gamma_{building[i]}$ denotes the time-invariant building fixed-effects and $\delta_{year[t]}$ the annual time fixed-effects. $\varepsilon_{i,t}$ again denotes the error term.

In line with the approach for the OLS cross-sectional model, I first run the model without the additional explanatory variables to obtain an estimate for the case where only the energy price is used to explain demand, and then include the set of additional explanatory variables in a second specification. Additionally, for the FE model, I also drop variables with limited explanatory power to arrive at a more condensed and relevant model specification. Furthermore, I also run a model where $ln(Price_{i,t)}$ is substituted by $ln(Price_{i,t-1})$, so taking the lag of the price variable in $t-1$ instead of the price in the same period to explain the space heating demand in period $t$.

All the models described represent the conditional demand. It therefore has to be inferred that the results reflect the short-term price elasticities of demand. The use of other dynamic estimation approaches to estimate long-term elasticities, as for example @alberini_etal11 or @csereklyei20 have done, would go beyond the scope of this thesis and are therefore not pursued. Additionally, the short-term price elasticities estimated here may also be viewed as lower bound estimates of the price responsiveness compared to the usually higher long-term estimates. As they are a lower bound estimate, they can also be considered as a conservative estimate for any kind of modelling or policy advice for which they might be used.

To estimate the OLS models, I rely on the lm-function in R. To estimate the FE models, I used the felm-function from the lfe-package [@gaure2013lfe].

**Bayesian estimation approach**

Beyond the use of OLS and FE as *classical* Frequentist methods used on the full sample, I move to the use of Bayesian inference when further analyzing a stratified random subsample of the data. In general, use of Bayesian inference has the advantage of allowing for the propagation of uncertainty in the modelling process [@mcelreath20]. Furthermore, the Bayesian framework allows for a more intuitive interpretation of modelling results being the actual chance of an event happening rather than the probability that the same outcome would occur if one were to replicate the data [@mcelreath20]. A further advantage of Bayesian inference on application where data is scarce would also be that due to the logic of updating beliefs based on evidence (data), integration of prior knowledge is possible [@gelman_etal21]. Here, I refrain from making strong assumptions on the prior distribution of model parameters and instead rely on weakly informed priors. Additionally, it should be pointed out that Bayesian inference is more computationally demanding than the methods presented above -- especially when integrating a model with a multilevel structure. This is the reason why Bayesian inference is only used on a subsample and not for the analysis of the full sample.

The subsample is set up a stratified random selection of 400 buildings per energy carrier group from the full sample. In In delimitation to the full sample analysis, the subsample analysis intends to serve two purposes. First, as mentioned in the previous paragraph, use of fewer data points makes the application of Bayesian methods possible which are well-suited to propagate uncertainty. Second, potential sources of heterogeneity in the price responsiveness shall be investigated. The stratified sampling approach where all three energy carrier groups are represented equally, allows the investigation of the carrier type as an potential additional source of heterogeneity. Furthermore, having a stronger representation of district heating than in the main sample also allows for a glimpse into the near future, when more gas and oil heating will become unviable due to the gas energy crisis and rising carbon prices, and will therefore be replaced by district heating (or heat pumps [^5278]).

[^5278]: Heat pumps are not considered here due to the still very limited data available on heat pump use in the billing sample.

For the analysis of the subsample, I first run the simple models that mirror the specifications from the OLS but in a Bayesian setting. When moving to the FE models I resort to the use of a multilevel partial pooling model with varying intercepts [@mcelreath20]. In the FE model, where information is clustered by the same units (buildings and years), there is no information sharing between units. This may lead to less reliable especially for the buildings cluster where there are sometimes only a few observations for one building. The multilevel partial pooling model with varying intercepts for each building and annual period, on the other hand, allows for information sharing among groups when estimating those intercepts [@mcelreath20]. For Together with the weakly informed priors mentioned earlier, the main model with the multilevel structure therefore takes the following form:

```{=tex}
\begin{align*}
ln(Demand_{i,t}) & \sim \operatorname{Normal}(\mu_{i,t}, \sigma) \\
\mu_{i,t} & \sim \bar\alpha + \gamma_{building[i]} + \delta_{year[t]} + \beta_1 \cdot ln(Price_{i,t}) +  \\
 & \quad \beta_{2} \cdot ln(Degree.days_{i,t}) + \beta_{3} \cdot ln(Heating.surface_{i,t}) + \\
 & \quad \beta_{4} \cdot Carrier.group.oil_{i,t} + \beta_{5} \cdot Carrier.group.district.heating_{i,t} + \\
 & \quad \beta_{6} \cdot ln(District.income_{i,t}) + \beta_{7} \cdot District.retire_{i,t} + \beta_{8} \cdot ln(Pop.density_{i,t}) \\
\bar\alpha & \sim \operatorname{Normal}(0, 1) \\
\gamma_j & \sim \operatorname{Normal}(0, \sigma_{\gamma}) \\
\delta_k & \sim \operatorname{Normal}(0, \sigma_{\delta}) \\
\beta_{1-8} & \sim \operatorname{Normal}(0, 0.5) \\
\sigma, \sigma_{\gamma}, \sigma_{\delta} & \sim \operatorname{Exponential}(1)
\end{align*}
```

Also for the Bayesian models, the response variable $ln(Demand_{i,t})$ denotes the natural logarithm of the annual space heating demand per square meter in building $i$ in the year $t$ and the main explanatory variable $ln(Price_{i,t})$ denotes the natural logarithm of the average energy price (Cents/kWh) in the same period. The intercept term ($\bar \alpha$) denotes the varying intercepts along the two grouping variables for partial pooling building ($\gamma_{building[i]}$) and year ($\delta_{year[t]}$). For the model I assume that all parameters follow a Gaussian distribution centered on 0. The intercept term $\bar \alpha$ is assumed to have a standard deviation of 1. The distribution parameter $\sigma$ as well as the parameters $\sigma_{\gamma}$ and $\sigma_{\delta}$ for the varying intercepts parameters were assumed to follow an $Exp(1)$ distribution so that they are limited to the positive values required for the standard deviation.

In the subsample analysis it is further the goal 

```{=tex}
\begin{align*}
ln(Demand_{i,t}) & \sim \operatorname{Normal}(\mu_{i,t}, \sigma) \\
\mu_{i,t} & \sim \bar\alpha + \gamma_{building[i]} + \delta_{year[t]} + \beta_1 \cdot ln(Price_{i,t}) +  \\
 & \quad \beta_{2} \cdot ln(Degree.days_{i,t}) + \beta_{3} \cdot ln(Heating.surface_{i,t}) + \\
 & \quad \beta_{4} \cdot Carrier.group.oil_{i,t} + \beta_{5} \cdot Carrier.group.district.heating_{i,t} + \\
 & \quad \beta_{6} \cdot ln(District.income_{i,t}) + \beta_{7} \cdot District.retire_{i,t} + \beta_{8} \cdot ln(Pop.density_{i,t}) + \\
 & \quad \beta_{9} \cdot ln(Price_{i,t}) \cdot Carrier.group.oil_{i,t} + \\
 & \quad \beta_{10} \cdot ln(Price_{i,t}) \cdot Carrier.group.district.heating_{i,t} \\
\bar\alpha & \sim \operatorname{Normal}(0, 1) \\
\gamma_j & \sim \operatorname{Normal}(0, \sigma_{\gamma}) \\
\delta_k & \sim \operatorname{Normal}(0, \sigma_{\delta}) \\
\beta_{1-10} & \sim \operatorname{Normal}(0, 0.5) \\
\sigma, \sigma_{\gamma}, \sigma_{\delta} & \sim \operatorname{Exponential}(1)
\end{align*}
```

The second model is an extension to the previous model introducing an additional interaction term between main explanatory variable $ln(Price_{i,t})$ and the categorical variable energy carrier group. Gas serves as the reference category.

The Bayesian models are estimated using the brms-package by @burkner17 in R. The brms-package serves as an interface to the probabilistic programming language and interence engine Stan [@standevelopmentteam22].


- https://cu-psych-computing.github.io/cu-psych-comp-tutorial/tutorials/r-extra/brms/multilevel-models-with-brms/


All from Labanderira et al.

discrete decision to purchase durable goods that consume energy and the decision to consume energy is rarely considered.renovations may disturbe the picture the panel data provides

On the other hand, most empirical studies in this area have used single-equation econometric models that require separability restrictions. This is a severe disadvantage as it is not possible to estimate cross-price effects between different energy products or consider the effects of non-energy products on the price elasticity of energy goods. 

Sample period. It is widely accepted that the economic cycle has a strong influence on energy consumption due to income and (indirect cycle-related) price effects. In the case of economic crises, for example, a depression of energy prices may occur; reduced disposable income may lead agents to reduce consumption through improvements in energy efficiency, adjustments to other types of consumption or changes towards other more inexpensive energy goods.

## Workflow {#workflow}

In Figure \@ref(fig:workflow1) the first part of the workflow of the empirical analysis is depicted. The upper part describes the data processing and the merging of the data. The bottom part shows the regression analyses performed on the full sample using ordinary least squares (OLS) and fixed effects (FE) regressions.

In Figure \@ref(fig:workflow2) the second part of the workflow is shown. After using Frequentist estimation techniques on the full sample, the analysis moves to the application of Bayesian regression analysis. For this purpose, a stratified random subsample by energy carrier group is created including 400 buildings per energy carrier group (Gas, Oil, District heating). Additionally, the subsample is used to investigate potential factors of heterogeneity in price responsiveness in the data first resorting to exploitative visual analysis and then moving to construct an interaction term model.

**Processing of billing sample and matching with supplementary data**

The energy billing data requires several steps of data processing to clean the data, which are shown in the upper part of Figure \@ref(fig:workflow1). After the data cleaning, 2,719,270 of the original 4,494,943 annual billing observations (60.5%) remain for the full sample analysis. The criteria applied in the cleaning process are ordered by the number of observations removed.

```{r workflow1, echo = FALSE, fig.cap = "Workflow of data processing and regression analysis based on full sample", out.width = "103%", fig.align = "center"}
knitr::include_graphics(path = "figure/workflow_diagramm_part1.pdf")
```

The most important reason for exclusion from the sample is the absence of price data. In the period 2003-2006, price data are not available for any of the observations. This leads to the exclusion of 909,458 observations. In addition, price data are also missing for a part of the observations in the period 2009-2019. Due to these gaps in the price data, a further 543,544 observations are excluded from the dataset. A further 233,888 observations are removed from the sample because they are associated with buildings that occur only once in the sample. The decision to apply this criterion was mainly due to the fact that singular building IDs occurred mainly in the period 2007-2008, suggesting that IDs from this period are not linked with observations in later periods. Furthermore, observing a building at least twice during the analysed period allowed for cross-validation of matching building attributes and therefore better reliability of the data. Another 53,674 observations were removed from the sample because the buildings are heated with an energy carrier other than gas, oil, or district heating. Due to the small number of buildings compared to the total sample size and due to the heterogeneity of the group (both very modern buildings with heat pumps and un-renovated buildings with coal heating), it was decided to exclude all other energy carriers from the sample. In addition, another 1,722 observations were excluded as duplicates (matching building ID and year) and 65 observations due to a deviating length of the billing period (deviation of more than +/- 10 days).

In addition to the factors described above, there are two other reasons for excluding observations from the sample. Both reasons are related to outliers in the energy price data. Compared to the other cleaning steps described above, performing the analysis with and without these two steps in place has shown that they can have a strong effect on the results of the analysis and are therefore particularly important.

First, it was determined through exploratory testing and confirmed by ista that the price data contains fictitious cost values (e.g., 1,000.00 Euros for the entire building) that are used as placeholders and do not reflect actual costs. These fictitious cost values arise because ista, as a billing service provider, does not always have information about the costs incurred by the building owners and therefore uses the placeholders for internal technical reasons. The actual costs are only entered later by the building owners and therefore do not appear in the sample.[^3489] This practice leads to the formation of outliers in the energy price data, as the fictitious cost values do not necessarily reflect the size and characteristics of a building. A total of 31,665 observations are removed due to fictitious cost values identified by searching for round cost rates without cent amounts that occur unusually often in the sample.

[^3489]: The internal practice of ista was reconstructed on the basis of an email exchange for the Wärmemonitor 2019, in which it was confirmed that the price data contain fictitious cost values.

Second, despite the removal of the fictitious cost values, some spurious outliers remained in the price data. An exploratory review of individual cases revealed that the remaining price outliers were likely due to data errors (e.g., unrealistic heating areas), which is not unusual given the very large number of observations in the sample. Although a relatively small number, the price outliers can significantly interfere with the results of the analysis. Therefore, it was decided to also exclude the remaining observations that showed unrealistic deviations from the reasonable price level expected during the observation period (real prices: <2 cents/kWh or >100 cents/kWh) or large price changes from one period to another (real prices: >10 or <-10 cents/kWh compared to the previous year). The exclusion thresholds were based on expert judgments and were chosen to exclude only highly of implausible observations. Use of the thresholds resulted in the exclusion of an additional 1,717 observations from the sample.

The processed billing data are then matched with the external data sources (see figure \@ref(fig:workflow1)). Due to missing degree days data or changes in the administrative areas, a further 1,940 observations are removed from the sample here, which ultimately leads to 2,719,270 remaining observations. After the processing, these observations are both complete and systematically checked for data errors that may have affected the outcome of the analysis.

**Regression analysis based on full sample**

[STILL MISSING]

**Stratified subsampling and Bayesian regression analysis**

[STILL MISSING]

```{r workflow2, echo = FALSE, fig.cap = "Workflow of stratified subsampling and Bayesian regression analysis based on subsample", out.width = "103%", fig.align = "center"}
knitr::include_graphics(path = "figure/workflow_diagramm_part2.pdf")
```

## Descriptive statistics {#descriptives}

**Unbalanced occurrence of buildings**

How often an individual building is observed in the processed and matched billing sample (full sample) is shown graphically in Figure \@ref(fig:occurrence-buildings). After excluding buildings that appeared only once in the sample (see Chapter \@ref(workflow)), buildings are observed on average 6.77 times during the observation period. The histogram shows that not all buildings are observed throughout the whole observation period, leading to the panel being unbalanced. While a relatively large number of buildings are observed only twice, the distribution exhibits a second peak at nine and ten times observed. This means that information on a relevant proportion of the buildings in the sample is available almost throughout the entire observation period.

```{r occurrence-buildings, echo = FALSE, fig.cap = "Number of occurrences of buildings in the full sample", out.width = "75%", fig.align = "center"}
knitr::include_graphics(path = "figure/occurance_buildings.pdf")
```

**Spatial and temporal coverage of sample**

In addition to how often an individual building is observed in the sample, also the spatial and temporal distribution of observations is of relevance. Figure \@ref(fig:buildings-distribution) graphically depicts the spatial and temporal coverage of the full sample on the district-level.[^41] On the spatial dimension, the maps show that the coverage is good. There are very few districts without any building observed (transparent) and only a few districts with less than 10 buildings observed per year (dark blue). For most district-year combinations, more than 100 buildings are observed. In some large cities and metropolitan areas, numbers of more than 10,000 buildings annually are reached. The good spatial coverage of the data implies that results drawn from the sample have validity for Germany as a whole and are in their explanatory power not limited to certain regions or clusters.

[^41]: Please note the use of the logarithmic scale in Figure \@ref(fig:buildings-distribution).

On the temporal dimension, fewer observations are available in 2007 (43,696 observations) and 2008 (43,536 observations), as the energy price data was first included in these years. For the years between 2009 and 2019, an annual minimum of 201,856 and an average of 239,183 buildings are observed. Which means that the explanatory power of the results applies in particular to the period between 2009 and 2019. At the same time, exploratory testing of the data with and without consideration of the years 2007 and 2008 did not lead to a relevant change in the results meaning that the results are applicable to the whole time period under investigation.

```{r buildings-distribution, echo = FALSE, fig.cap = "Spatial and temporal coverage by the buildings observed", out.width = "77%", fig.align = "center"}
knitr::include_graphics(path = "figure/buildings_distribution.pdf")
```

**Summary statistics**

Table \@ref(tab:summary-statistics) provides summary statistics for the full sample reporting the median values and the interquartile range (IQR). Besides the overall sample, also separate statistics for the three carrier types gas, oil, and district heating are included. About 60.6% of the observations in the sample are associated with gas as the energy carrier. A further 29.5% with oil and 9.9% with district heating. For space heat demand, as the response variable, the median value (IQR) for the sample overall is 113 (86, 145) kWh/sqm/a and for energy price as the main explanatory variable the median (IQR) of the sample is 6.49 (5.77, 7.69) Cents/kWh.

\begin{table}[]
\centering
\caption{Summary statistics}
\label{tab:summary-statistics}
\resizebox{\textwidth}{!}{%
\begin{tabular}{@{}llllll@{}}
\toprule
Variable {[}Median (IQR){]} &
  Unit &
  \begin{tabular}[c]{@{}l@{}}Overall\\ N = 2,718,246\end{tabular} &
  \begin{tabular}[c]{@{}l@{}}Gas\\ N = 1,647,563 (60.6\%)\end{tabular} &
  \begin{tabular}[c]{@{}l@{}}Oil\\ N = 802,451 (29.5\%)\end{tabular} &
  \begin{tabular}[c]{@{}l@{}}District heating\\ N = 268,232 (9.9\%)\end{tabular} \\ \midrule
                                         &                 &                      &                      &                      &                      \\
Space heat demand, eff.                  & {[}kWh/sqm{]}   & 113 (86, 145)        & 116 (89, 149)        & 117 (91, 148)        & 83 (63, 109)         \\
Energy price, real                       & {[}Cents/kWh{]} & 6.49 (5.77, 7.69)    & 6.18 (5.56, 6.79)    & 7.06 (6.08, 8.25)    & 10.12 (8.71, 11.84)  \\
                                         &                 &                      &                      &                      &                      \\
Degree days                              &                 & 3,446 (3,214, 3,733) & 3,418 (3,192, 3,697) & 3,536 (3,273, 3,826) & 3,397 (3,191, 3,642) \\
Heating surface                          & {[}sqm{]}       & 404 (260, 707)       & 424 (271, 701)       & 305 (226, 466)       & 1,118 (556, 2,118)   \\
Housing units                            &                 & 6 (3, 10)            & 6 (3, 10)            & 4 (3, 6)             & 16 (8, 32)           \\
                                         &                 &                      &                      &                      &                      \\
\begin{tabular}[c]{@{}l@{}}District household income,\\ per capita\end{tabular} &
  {[}€/a{]} &
  20,695 (18,786, 22,568) &
  20,658 (18,731, 22,563) &
  21,098 (19,388, 22,861) &
  19,217 (17,667, 21,327) \\
District retirement share                & {[}\%{]}        & 0.207 (0.193, 0.220) & 0.209 (0.194, 0.222) & 0.205 (0.193, 0.216) & 0.210 (0.192, 0.230) \\
Postal code population density &
  \begin{tabular}[c]{@{}l@{}}{[}inhabitants/\\ sq. km{]}\end{tabular} &
  572 (217, 1,960) &
  662 (255, 2,121) &
  320 (149, 839) &
  2,053 (505, 4,821) \\ \midrule
\textit{Note: Median (IQR), No missings} &                 &                      &                      &                      &                      \\ \bottomrule
\end{tabular}%
}
\end{table}


In terms of energy demand and price, there are pronounced and relevant differences between the three types of energy carrier groups. The demand for gas and oil as energy carriers is higher than for district heating. The prices for gas are the lowest with relatively small fluctuations. Prices for oil are slightly higher, but show greater variation. Prices for district heating are by far the highest and also show the greatest variations. Additionally, buildings with a district heating system installed are three to four times the size of buildings with gas or oil heating installed (cf. heating surface and housing units in Table \@ref(tab:summary-statistics)). To check for potential multicollinearity issues between the variables Appendix \@ref(fig:correlation-plot) shows a matrix of Pearson's correlation coefficients. None of the correlations observed between the variables exceed moderate values, which rules out any multicollinearity issues. Furthermore, the correlation matrix reveals that energy price is negatively correlated with energy demand, indicating that the expected negative relationship is reflected in the data.

**Focus on energy demand and prices**

Figure \@ref(fig:demand-descriptive-graph) provides a more detailed visual summary of the demand variable. The aggregated demand distribution of the three carrier types and years tapers off towards the upper end. The lowest annual demands are around 25 kWh/sqm/a. The distribution peaks at just over 100 kWh/sqm/a and then tapers off to very high demand values of up to 350 kWh/sqm/a (Panel A). With a differentiated display by energy carrier (Panel B), the graph confirms the findings from Table \@ref(tab:summary-statistics). While the demands for gas and oil are on an almost similar higher level, demand in buildings with district heating is considerably lower. The major share of this difference in demand is most likely attributable to the difference in building size. Because buildings heated with district heating are on average three to four times larger than buildings with oil or gas heating, they have a better ratio of heating area to building exterior area, resulting in lower heat losses per square meter heated. Given the significance of the difference in demand, it was further scrutinized if the age of the building and the age of the heating system may deviate between gas and oil buildings on the one side and buildings with district heating on the other side. Newer buildings and newer heating systems would be expected to go along with lower energy demand. Appendix \@ref(tab:age-building-heating-system) provides this comparison, which finds no differences between energy carriers of a magnitude that would suggest a strong impact on demand.

```{r demand-descriptive-graph, echo = FALSE, fig.cap = "Distribution of energy demand", out.width = "100%", fig.align = "center"}
knitr::include_graphics(path = "figure/demand_descriptive.pdf")
```

In addition, Panel B of Figure \@ref(fig:demand-descriptive-graph) provides two additional relevant pieces of information regarding the energy demand variable. First, for all three carrier types the effective demand decreases over time. This is most likely due to multiple factors one of which would be the demand response investigated in this thesis. Additionally, over time, newer more energy efficient buildings are added to the sample, while old and more inefficient building stock likely drops from the sample. Furthermore, the building stock remaining in the sample may undergo renovation measures leading to lower energy demand. Lastly, increasing outside temperatures due to climate change may also lead to the decline in effective demand observed. Linked to the role of climatic conditions is also a second aspect which can also be derived from the graph: Effective demand follows a similar pattern for all carriers, which can, however, also turn out to be higher or lower from year to year and only declines in the overall trend. Fluctuations in effective energy demand are linked to the variations in climatic conditions. In Appendix \@ref(fig:degree-days-distribution) the distribution of degree days is depicted on a spatial and temporal scale. There is a consistent trend between degree days and energy demand that corroborates the intuition that higher degree days (lower outside temperatures) leads to higher energy demand. This illustrates the relevance of considering climatic conditions as an additional determinant of space heating demand.

Figure \@ref(fig:price-descriptive-graph) depicts the distribution of nominal (Panel A) and real (Panel B) energy prices also by energy carrier. The points represent the average price in one year. The vertical bars represent the standard deviation. While the energy prices for gas are relatively stable over the period under observation, prices for oil show stronger volatility. As already established previously, prices for district heating are higher than those for gas and oil (cf. Table \@ref(tab:summary-statistics)). Furthermore, the prices for district heating are not as volatile, but show a huge range of variation, which is reflected in the much larger standard deviations.

```{r price-descriptive-graph, echo = FALSE, fig.cap = "Distribution of nominal and real energy prices", out.width = "100%", fig.align = "center"}
knitr::include_graphics(path = "figure/prices_descriptive.pdf")
```

While nominal prices are relatively stable in the overall trend for all three energy carrier groups, the trend changes after adjusting for inflation. The deflated real prices show an overall declining trend, with the trend being more pronounced for gas and oil. For the intuition about the price elasticity of space heating demand, this means that one would expect an overall increase in demand from the price effect alone. However, the graph also shows that effects into both directions can be observed when looking not at the overall trend but at year-to-year movements.

After having described the data and energy demand and energy prices as the two main variables in detail, the following Chapter will present the results of the regression analysis.
